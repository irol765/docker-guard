name: Docker Build & Push

on:
  push:
    branches: [ "main" ]
    # å½“æ‰“ tag (å¦‚ v1.0) æ—¶ä¹Ÿè§¦å‘
    tags: [ 'v*.*.*' ]
    # å½“ README æ”¹åŠ¨æ—¶ä¹Ÿè§¦å‘
    paths:
      - 'README.md'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # ä½ çš„ Docker Hub ä»“åº“å
  IMAGE_NAME: irol765/docker-guard

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # === ğŸ” æ–°å¢è°ƒè¯•æ­¥éª¤ (å¼€å§‹) ===
      - name: Debug Secrets
        run: |
          echo "æ­£åœ¨æ£€æŸ¥ Secrets..."
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "âŒ é”™è¯¯: DOCKERHUB_USERNAME æ˜¯ç©ºçš„ï¼è¯·æ£€æŸ¥æ‹¼å†™ (ç»“å°¾æœ‰æ²¡æœ‰E?) æˆ–ä½ç½® (Repository secrets?)"
            exit 1
          else
            echo "âœ… DOCKERHUB_USERNAME è¯»å–æˆåŠŸ (é•¿åº¦: ${#DOCKERHUB_USERNAME})"
          fi
          
          if [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "âŒ é”™è¯¯: DOCKERHUB_TOKEN æ˜¯ç©ºçš„ï¼"
            exit 1
          else
            echo "âœ… DOCKERHUB_TOKEN è¯»å–æˆåŠŸ"
          fi
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      # === ğŸ” æ–°å¢è°ƒè¯•æ­¥éª¤ (ç»“æŸ) ===

      # 1. é…ç½® QEMU (ç”¨äºæ”¯æŒ ARM64 æ„å»º)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 2. é…ç½® Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3. ç™»å½• Docker Hub
      - name: Log into Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 4. æå–å…ƒæ•°æ® (è‡ªåŠ¨å¤„ç† tags)
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=semver,pattern={{version}}

      # 5. æ„å»ºå¹¶æ¨é€ (åŒæ¶æ„: amd64 + arm64)
      - name: Build and push Docker image
        # åªæœ‰å½“é README å˜åŠ¨æ—¶æ‰æ„å»ºé•œåƒï¼ŒèŠ‚çœèµ„æº
        if: github.event_name != 'push' || !contains(github.event.head_commit.message, 'docs')
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # åœ¨è¿™é‡ŒæŒ‡å®šå¤šæ¶æ„
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      # 6. ã€æ–°å¢ã€‘è‡ªåŠ¨åŒæ­¥ README åˆ° Docker Hub
      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ env.IMAGE_NAME }}
          readme-filepath: ./README.md
